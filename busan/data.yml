region: "ap-northeast-2"
region_name: "busan"

# aws vpc에서 사용할 가용 영역 수
number_of_azs: 2

# aws vpc 네트워크 구성 정보
network:
  cidr_block: "10.3.0.0/16"
  subnet_bits: 8
  number_of_public_subnets: 2
  number_of_private_subnets: 2
  number_of_nat_gws: 1

sg_list:
  elk:
    ingress_rules:
      elastic1:
        protocol: "tcp"
        from_port: 9200
        to_port: 9200
        cidr_blocks: ["0.0.0.0/0"]

      elastic2: 
        protocol: "tcp"
        from_port: 9300
        to_port: 9300
        cidr_blocks: ["0.0.0.0/0"]

      kibana:
        protocol: "tcp"
        from_port: 5601
        to_port: 5601
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}

  web:
    ingress_rules:
      http:
        protocol: "tcp"
        from_port: 80
        to_port: 80
        cidr_blocks: ["0.0.0.0/0"]
      https:
        protocol: tcp
        from_port: 443
        to_port: 443
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}
  db:
    ingress_rules:
      mariadb:
        protocol: tcp
        from_port: 3306
        to_port: 3306
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}
  dns:
    ingress_rules:
      tcp:
        protocol: tcp
        from_port: 53
        to_port: 53
        cidr_blocks: ["0.0.0.0/0"]
      udp:
        protocol: udp
        from_port: 53
        to_port: 53
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}
  remote:
    ingress_rules:
      ssh:
        protocol: "tcp"
        from_port: 22
        to_port: 22
        cidr_blocks: ["0.0.0.0/0"]

      telnet:
        protocol: "tcp"
        from_port: 23
        to_port: 23
        cidr_blocks: ["0.0.0.0/0"]

      rdp:
        protocol: "tcp"
        from_port: 3389
        to_port: 3389
        cidr_blocks: ["0.0.0.0/0"]

      vnc:
        protocol: "tcp"
        from_port: 5900
        to_port: 5900
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}

  default_out:
    ingress_rules: {}

    egress_rules:
      all_outbound:
        protocol: "-1"
        from_port: 0
        to_port: 0
        cidr_blocks: ["0.0.0.0/0"]

  icmp :
    ingress_rules:
      echo :
        protocol: "icmp"
        from_port: 8
        to_port: 0
        cidr_blocks: ["0.0.0.0/0"]
    egress_rules: {}


lb_target_group : 
  target_type      : "instance"
  name             : "target-group-webservers"
  protocol         : "HTTP"
  port             : 80
  protocol_version : "HTTP1"

  health_check : 
    protocol            : "HTTP"
    path                : "/"
    healthy_threshold   : 2
    unhealthy_threshold : 3
    timeout             : 5
    interval            : 10
    matcher             : "200-299"
  
lb : 
  load_balancer_type : "application"
  name               : "lb-webservers"
  internal           : false
  ip_address_type    : "ipv4"
  sg_names           : ["default_out", "web","remote"]

lb_listener : 
  port     : "80"
  protocol : "HTTP"

  default_action : 
    type : "forward"

record : 
  zone_id    : "Z032662211JM2TEXY5ZXL"
  name       : "www.f1.it-edu.org"
  type       : "CNAME"
  ttl        : 77 

autoscaling_group : 
  dvwa-filebeat:
    name                      : "dvwa-filebeat-busan"
    desired_capacity          : 1
    min_size                  : 1
    max_size                  : 1
    health_check_type         : "ELB"
    health_check_grace_period : 120

autoscaling_policy : 
  name                      : "Target Tracking Policy"
  policy_type               : "TargetTrackingScaling"
  predefined_metric_type    : "ASGAverageCPUUtilization"
  target_value              : 30
  estimated_instance_warmup : 120

key_info :
  algorithm : "ED25519"
  rsa_bits : 0

ec2_instances : 
  web : 
    count         : 0
    ami_id        : "ami-0e967ff96936c0c0c"
    instance_type : "t2.micro"
    sg_names      : ["default_out", "icmp", "remote", "web"]
    public        : true
  
  db : 
    count         : 0
    ami_id        : "ami-0e967ff96936c0c0c"
    instance_type : "t2.micro"
    sg_names      : ["default_out", "icmp", "remote", "db"]
    public        : false
  
  dns : 
    count         : 0
    ami_id        : "ami-0e967ff96936c0c0c"
    instance_type : "t2.micro"
    sg_names      : ["default_out", "icmp", "remote", "dns"]
    public        : true

launch_template:
  dvwa-filebeat:
    name_prefix            : "dvwa-filebeat-busan"
    description            : "dvwa-filebeat template"
    image_id               : "ami-07f7f3cd9e3629027"
    instance_type          : "t2.micro"
    key_name               : "busan-ed25519-key"
    sg_names               : ["default_out", "web","remote", "icmp","db"]
    user_data              : |
      #!/bin/bash

      hostnamectl hostname dvwa.f1.it-edu.org

      HOSTED_ZONE_ID="Z032662211JM2TEXY5ZXL"
      RECORD_NAME="dvwa2.f1.it-edu.org."
      TTL=60

      TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 3600")
      INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/instance-id)
      PRIVATE_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-ipv4)
      PUBLIC_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/public-ipv4)

      cat > /tmp/route53-record.json <<EOF
      {
        "Comment": "Create A record for EC2 instance",
        "Changes": [
          {
            "Action": "UPSERT",
            "ResourceRecordSet": {
              "Name": "$RECORD_NAME",
              "Type": "A",
              "TTL": $TTL,
              "ResourceRecords": [
                {
                  "Value": "$PUBLIC_IP"
                }
              ]
            }
          }
        ]
      }
      EOF
      aws route53 change-resource-record-sets  --hosted-zone-id "$HOSTED_ZONE_ID" --change-batch file:///tmp/route53-record.json

    network_interfaces : 
      associate_public_ip_address : true
      delete_on_termination       : true
  